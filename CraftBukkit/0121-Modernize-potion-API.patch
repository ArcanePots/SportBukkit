From d868b3fa5b3f11d1218d0d9f32bfb83c5600455b Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Thu, 10 Mar 2016 15:10:18 -0500
Subject: [PATCH] Modernize potion API


diff --git a/src/main/java/net/minecraft/server/MobEffectList.java b/src/main/java/net/minecraft/server/MobEffectList.java
index f6a231b..bb8fbbb 100644
--- a/src/main/java/net/minecraft/server/MobEffectList.java
+++ b/src/main/java/net/minecraft/server/MobEffectList.java
@@ -224,10 +224,5 @@ public class MobEffectList {
         MobEffectList.REGISTRY.a(25, new MinecraftKey("levitation"), (new MobEffectList(true, 13565951)).c("effect.levitation").b(3, 2));
         MobEffectList.REGISTRY.a(26, new MinecraftKey("luck"), (new MobEffectList(false, 3381504)).c("effect.luck").b(5, 2).j().a(GenericAttributes.i, "03C3C89D-7037-4B42-869F-B146BCB64D2E", 1.0D, 0));
         MobEffectList.REGISTRY.a(27, new MinecraftKey("unluck"), (new MobEffectList(true, 12624973)).c("effect.unluck").b(6, 2).a(GenericAttributes.i, "CC5AF142-2BD2-4215-B636-2605AED11727", -1.0D, 0));
-        // CraftBukkit start
-        for (Object effect : REGISTRY) {
-            org.bukkit.potion.PotionEffectType.registerPotionEffectType(new org.bukkit.craftbukkit.potion.CraftPotionEffectType((MobEffectList) effect));
-        }
-        // CraftBukkit end
     }
 }
diff --git a/src/main/java/org/bukkit/CraftBukkitRuntime.java b/src/main/java/org/bukkit/CraftBukkitRuntime.java
index 6fe7b03..531d9f6 100644
--- a/src/main/java/org/bukkit/CraftBukkitRuntime.java
+++ b/src/main/java/org/bukkit/CraftBukkitRuntime.java
@@ -4,7 +4,11 @@ import net.minecraft.server.DispenserRegistry;
 import org.bukkit.block.RegionFactory;
 import org.bukkit.craftbukkit.block.CraftRegionFactory;
 import org.bukkit.craftbukkit.inventory.CraftItemFactory;
+import org.bukkit.craftbukkit.potion.CraftPotionEffectRegistry;
+import org.bukkit.craftbukkit.potion.CraftPotionBrewRegistry;
 import org.bukkit.craftbukkit.registry.CraftKey;
+import org.bukkit.potion.PotionEffectRegistry;
+import org.bukkit.potion.PotionBrewRegistry;
 import org.bukkit.registry.Key;
 
 public class CraftBukkitRuntime implements BukkitRuntime {
@@ -22,6 +26,9 @@ public class CraftBukkitRuntime implements BukkitRuntime {
         }
     }
 
+    private final PotionBrewRegistry potionBrewRegistry = new CraftPotionBrewRegistry();
+    private final PotionEffectRegistry potionEffectRegistry = new CraftPotionEffectRegistry();
+
     public CraftBukkitRuntime() {
         DispenserRegistry.c();
     }
@@ -45,4 +52,14 @@ public class CraftBukkitRuntime implements BukkitRuntime {
     public RegionFactory getRegionFactory() {
         return CraftRegionFactory.instance();
     }
+
+    @Override
+    public PotionBrewRegistry potionRegistry() {
+        return potionBrewRegistry;
+    }
+
+    @Override
+    public PotionEffectRegistry potionEffectRegistry() {
+        return potionEffectRegistry;
+    }
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaPotion.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaPotion.java
index e29e00c..e456b43 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaPotion.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaPotion.java
@@ -9,9 +9,12 @@ import net.minecraft.server.NBTTagCompound;
 import net.minecraft.server.NBTTagList;
 
 import org.apache.commons.lang.Validate;
+import org.bukkit.Bukkit;
 import org.bukkit.Material;
 import org.bukkit.configuration.serialization.DelegateDeserialization;
 import org.bukkit.inventory.meta.PotionMeta;
+import org.bukkit.potion.PotionBrew;
+import org.bukkit.potion.PotionBrewRegistry;
 import org.bukkit.potion.PotionData;
 import org.bukkit.potion.PotionEffect;
 import org.bukkit.potion.PotionEffectType;
@@ -151,6 +154,19 @@ class CraftMetaPotion extends CraftMetaItem implements PotionMeta {
         return type;
     }
 
+    @Override
+    public void setPotionBrew(PotionBrew brew) {
+        this.type = CraftPotionUtil.toBukkit(brew.key().toString());
+    }
+
+    @Override
+    public PotionBrew getPotionBrew() {
+        final PotionBrewRegistry registry = Bukkit.potionRegistry();
+        if(this.type == null) return registry.getFallback();
+        final PotionBrew brew = registry.get(Bukkit.key(CraftPotionUtil.fromBukkit(this.type)));
+        return brew != null ? brew : registry.getFallback();
+    }
+
     public boolean hasCustomEffects() {
         return customEffects != null;
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrew.java b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrew.java
new file mode 100644
index 0000000..be7b0d2
--- /dev/null
+++ b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrew.java
@@ -0,0 +1,36 @@
+package org.bukkit.craftbukkit.potion;
+
+import java.util.List;
+
+import com.google.common.base.Function;
+import com.google.common.collect.Lists;
+import net.minecraft.server.MobEffect;
+import net.minecraft.server.PotionRegistry;
+import org.bukkit.craftbukkit.registry.CraftKey;
+import org.bukkit.potion.PotionEffect;
+import org.bukkit.potion.PotionBrew;
+import org.bukkit.registry.Key;
+
+public class CraftPotionBrew implements PotionBrew {
+
+    private final PotionRegistry handle;
+
+    public CraftPotionBrew(PotionRegistry handle) {
+        this.handle = handle;
+    }
+
+    @Override
+    public Key key() {
+        return CraftKey.get(PotionRegistry.a.b(handle));
+    }
+
+    @Override
+    public List<PotionEffect> effects() {
+        return Lists.transform(handle.a(), new Function<MobEffect, PotionEffect>() {
+            @Override
+            public PotionEffect apply(MobEffect nms) {
+                return CraftPotionUtils.toBukkit(nms);
+            }
+        });
+    }
+}
diff --git a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewRegistry.java b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewRegistry.java
new file mode 100644
index 0000000..c9fbaf2
--- /dev/null
+++ b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionBrewRegistry.java
@@ -0,0 +1,24 @@
+package org.bukkit.craftbukkit.potion;
+
+import net.minecraft.server.PotionRegistry;
+import org.bukkit.craftbukkit.registry.CraftKey;
+import org.bukkit.craftbukkit.registry.CraftRegistry;
+import org.bukkit.potion.PotionBrew;
+import org.bukkit.potion.PotionBrewRegistry;
+
+public class CraftPotionBrewRegistry extends CraftRegistry<PotionBrew, PotionRegistry> implements PotionBrewRegistry {
+
+    public CraftPotionBrewRegistry() {
+        super(PotionBrew.class, PotionRegistry.a);
+    }
+
+    @Override
+    protected PotionBrew createBukkit(PotionRegistry nms) {
+        return new CraftPotionBrew(nms);
+    }
+
+    @Override
+    public PotionBrew getFallback() {
+        return need(CraftKey.get("minecraft:empty"));
+    }
+}
diff --git a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectRegistry.java b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectRegistry.java
new file mode 100644
index 0000000..94e0a5f
--- /dev/null
+++ b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectRegistry.java
@@ -0,0 +1,37 @@
+package org.bukkit.craftbukkit.potion;
+
+import net.minecraft.server.MobEffectList;
+import org.bukkit.craftbukkit.registry.CraftRegistry;
+import org.bukkit.potion.PotionEffectRegistry;
+import org.bukkit.potion.PotionEffectType;
+
+public class CraftPotionEffectRegistry extends CraftRegistry<PotionEffectType, MobEffectList> implements PotionEffectRegistry {
+
+    public CraftPotionEffectRegistry() {
+        super(PotionEffectType.class, MobEffectList.REGISTRY);
+    }
+
+    @Override
+    protected PotionEffectType createBukkit(MobEffectList nms) {
+        return new CraftPotionEffectType(nms);
+    }
+
+    @Override
+    public PotionEffectType getFallback() {
+        return null;
+    }
+
+    @Override
+    public PotionEffectType forLegacyId(int legacyId) {
+        final MobEffectList nms = MobEffectList.fromId(legacyId);
+        return nms == null ? null : toBukkit(nms);
+    }
+
+    @Override
+    public PotionEffectType forLegacyName(String legacyName) {
+        for(PotionEffectType type : this) {
+            if(legacyName.equals(type.getName())) return type;
+        }
+        return null;
+    }
+}
diff --git a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectType.java b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectType.java
index 8ce39c6..cd4b85d 100644
--- a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectType.java
+++ b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionEffectType.java
@@ -1,14 +1,14 @@
 package org.bukkit.craftbukkit.potion;
 
 import net.minecraft.server.MobEffectList;
-
+import org.bukkit.craftbukkit.registry.CraftKey;
 import org.bukkit.potion.PotionEffectType;
+import org.bukkit.registry.Key;
 
 public class CraftPotionEffectType extends PotionEffectType {
     private final MobEffectList handle;
 
     public CraftPotionEffectType(MobEffectList handle) {
-        super(MobEffectList.getId(handle));
         this.handle = handle;
     }
 
@@ -22,6 +22,16 @@ public class CraftPotionEffectType extends PotionEffectType {
     }
 
     @Override
+    public Key key() {
+        return CraftKey.get(MobEffectList.REGISTRY.b(handle));
+    }
+
+    @Override
+    public int getId() {
+        return MobEffectList.getId(handle);
+    }
+
+    @Override
     public String getName() {
         switch (getId()) {
         case 1:
-- 
1.9.0

