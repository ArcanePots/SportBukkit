From cd2a368e0bbbb7e141f4ce4da1766550ae208436 Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Fri, 2 Dec 2016 01:48:56 -0500
Subject: [PATCH] New event API


diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index d47b2b0..7b65f00 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -79,6 +79,8 @@ import org.bukkit.craftbukkit.util.DatFileFilter;
 import org.bukkit.craftbukkit.util.Versioning;
 import org.bukkit.craftbukkit.util.permissions.CraftDefaultPermissions;
 import org.bukkit.entity.Player;
+import org.bukkit.event.EventBus;
+import org.bukkit.event.SimpleEventBus;
 import org.bukkit.event.inventory.InventoryType;
 import org.bukkit.event.player.PlayerChatTabCompleteEvent;
 import org.bukkit.event.world.WorldInitEvent;
@@ -123,7 +125,6 @@ import com.avaje.ebeaninternal.server.lib.sql.TransactionIsolation;
 import com.google.common.base.Charsets;
 import com.google.common.base.Function;
 import com.google.common.collect.ImmutableList;
-import com.google.common.collect.ImmutableSet;
 import com.google.common.collect.Lists;
 import com.google.common.collect.MapMaker;
 import com.mojang.authlib.GameProfile;
@@ -149,6 +150,7 @@ public final class CraftServer extends CraftBukkitRuntime implements Server {
     private final SimpleHelpMap helpMap = new SimpleHelpMap(this);
     private final StandardMessenger messenger = new StandardMessenger();
     private final PluginManager pluginManager = new SimplePluginManager(this, commandMap);
+    private final EventBus eventBus;
     protected final MinecraftServer console;
     protected final DedicatedPlayerList playerList;
     private final Map<String, World> worlds = new LinkedHashMap<String, World>();
@@ -167,6 +169,7 @@ public final class CraftServer extends CraftBukkitRuntime implements Server {
     public int chunkGCLoadThresh = 0;
     private File container;
     private WarningState warningState = WarningState.DEFAULT;
+    private boolean pluginProfiling;
     private final BooleanWrapper online = new BooleanWrapper();
     public CraftScoreboardManager scoreboardManager;
     public boolean playerCommandState;
@@ -191,6 +194,7 @@ public final class CraftServer extends CraftBukkitRuntime implements Server {
 
     public CraftServer(MinecraftServer console, PlayerList playerList) {
         this.console = console;
+        this.eventBus = new SimpleEventBus(this.console.primaryThread, pluginManager);
         this.playerList = (DedicatedPlayerList) playerList;
         this.playerView = Collections.unmodifiableList(Lists.transform(playerList.players, new Function<EntityPlayer, CraftPlayer>() {
             @Override
@@ -254,7 +258,7 @@ public final class CraftServer extends CraftBukkitRuntime implements Server {
         saveCommandsConfig();
         bungee = configuration.getBoolean("settings.bungeecord");
         overrideAllCommandBlockCommands = commandsConfiguration.getStringList("command-block-overrides").contains("*");
-        ((SimplePluginManager) pluginManager).useTimings(configuration.getBoolean("settings.plugin-profiling"));
+        pluginProfiling = configuration.getBoolean("settings.plugin-profiling");
         monsterSpawn = configuration.getInt("spawn-limits.monsters");
         animalSpawn = configuration.getInt("spawn-limits.animals");
         waterAnimalSpawn = configuration.getInt("spawn-limits.water-animals");
@@ -678,6 +682,11 @@ public final class CraftServer extends CraftBukkitRuntime implements Server {
     }
 
     @Override
+    public EventBus eventBus() {
+        return eventBus;
+    }
+
+    @Override
     public List<World> getWorlds() {
         return new ArrayList<World>(worlds.values());
     }
@@ -1670,6 +1679,11 @@ public final class CraftServer extends CraftBukkitRuntime implements Server {
         return warningState;
     }
 
+    @Override
+    public boolean pluginProfiling() {
+        return pluginProfiling;
+    }
+
     public List<String> tabComplete(net.minecraft.server.ICommandListener sender, String message, BlockPosition pos) {
         if (!(sender instanceof EntityPlayer)) {
             return ImmutableList.of();
-- 
1.9.0

