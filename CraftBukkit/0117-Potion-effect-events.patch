From 4074c0eb990e97652b3bf8e1f098684e3d4519e2 Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Mon, 29 Jun 2015 04:47:28 -0400
Subject: [PATCH] Potion effect events


diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 27b6d82..b17c72f 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -15,11 +15,16 @@ import java.util.ArrayList;
 import com.google.common.base.Function;
 import com.google.common.collect.Lists;
 import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.craftbukkit.potion.CraftPotionUtils;
 import org.bukkit.entity.LivingEntity;
 import org.bukkit.entity.Vehicle;
 import org.bukkit.event.entity.EntityDamageEvent;
 import org.bukkit.event.entity.EntityDamageEvent.DamageModifier;
 import org.bukkit.event.entity.EntityRegainHealthEvent;
+import org.bukkit.event.entity.PotionEffectAddEvent;
+import org.bukkit.event.entity.PotionEffectExpireEvent;
+import org.bukkit.event.entity.PotionEffectExtendEvent;
+import org.bukkit.event.entity.PotionEffectRemoveEvent;
 import org.bukkit.event.vehicle.VehicleExitEvent;
 import org.bukkit.craftbukkit.entity.CraftLivingEntity;
 // CraftBukkit end
@@ -459,13 +464,24 @@ public abstract class EntityLiving extends Entity {
     protected void bi() {
         Iterator iterator = this.effects.keySet().iterator();
 
-        isTickingEffects = true; // CraftBukkit
+        try { isTickingEffects = true; // CraftBukkit
         while (iterator.hasNext()) {
             Integer integer = (Integer) iterator.next();
             MobEffect mobeffect = (MobEffect) this.effects.get(integer);
 
             if (!mobeffect.tick(this)) {
                 if (!this.world.isClientSide) {
+                    // SportBukkit start - fire event
+                    PotionEffectExpireEvent event = new PotionEffectExpireEvent((LivingEntity) this.getBukkitEntity(),
+                                                                                CraftPotionUtils.toBukkit(mobeffect));
+                    this.world.getServer().getPluginManager().callEvent(event);
+                    if(event.isCancelled()) {
+                        // Duration must be extended if event is cancelled
+                        CraftPotionUtils.extendDuration(mobeffect, event.getDuration());
+                        continue;
+                    }
+                    // SportBukkit end
+
                     iterator.remove();
                     this.b(mobeffect);
                 }
@@ -474,7 +490,7 @@ public abstract class EntityLiving extends Entity {
             }
         }
         // CraftBukkit start
-        isTickingEffects = false;
+        } finally { isTickingEffects = false; }
         for (Object e : effectsToProcess) {
             if (e instanceof MobEffect) {
                 addEffect((MobEffect) e);
@@ -553,8 +569,11 @@ public abstract class EntityLiving extends Entity {
             MobEffect mobeffect = (MobEffect) this.effects.get(integer);
 
             if (!this.world.isClientSide) {
-                iterator.remove();
-                this.b(mobeffect);
+                // SportBukkit start - go through method that fires event
+                this.removeEffect(integer);
+                //iterator.remove();
+                //this.b(mobeffect);
+                // SportBukkit end
             }
         }
 
@@ -586,9 +605,24 @@ public abstract class EntityLiving extends Entity {
         // CraftBukkit end
         if (this.d(mobeffect)) {
             if (this.effects.containsKey(Integer.valueOf(mobeffect.getEffectId()))) {
+                // SportBukkit start - fire event
+                PotionEffectExtendEvent event = new PotionEffectExtendEvent((LivingEntity) this.getBukkitEntity(),
+                                                                            CraftPotionUtils.toBukkit(mobeffect),
+                                                                            CraftPotionUtils.toBukkit(this.effects.get(mobeffect.getEffectId())));
+                this.world.getServer().getPluginManager().callEvent(event);
+                if(event.isCancelled()) return;
+                // SportBukkit end
+
                 ((MobEffect) this.effects.get(Integer.valueOf(mobeffect.getEffectId()))).a(mobeffect);
                 this.a((MobEffect) this.effects.get(Integer.valueOf(mobeffect.getEffectId())), true);
             } else {
+                // SportBukkit start - fire event
+                PotionEffectAddEvent event = new PotionEffectAddEvent((LivingEntity) this.getBukkitEntity(),
+                                                                      CraftPotionUtils.toBukkit(mobeffect));
+                this.world.getServer().getPluginManager().callEvent(event);
+                if(event.isCancelled()) return;
+                // SportBukkit end
+
                 this.effects.put(Integer.valueOf(mobeffect.getEffectId()), mobeffect);
                 this.a(mobeffect);
             }
@@ -622,6 +656,16 @@ public abstract class EntityLiving extends Entity {
         MobEffect mobeffect = (MobEffect) this.effects.remove(Integer.valueOf(i));
 
         if (mobeffect != null) {
+            // SportBukkit start
+            PotionEffectRemoveEvent event = new PotionEffectRemoveEvent((LivingEntity) this.getBukkitEntity(),
+                                                                        CraftPotionUtils.toBukkit(mobeffect));
+            this.world.getServer().getPluginManager().callEvent(event);
+            if(event.isCancelled()) {
+                this.effects.put(i, mobeffect);
+                return;
+            }
+            // SportBukkit end
+
             this.b(mobeffect);
         }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionUtils.java b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionUtils.java
new file mode 100644
index 0000000..1374199
--- /dev/null
+++ b/src/main/java/org/bukkit/craftbukkit/potion/CraftPotionUtils.java
@@ -0,0 +1,33 @@
+package org.bukkit.craftbukkit.potion;
+
+import net.minecraft.server.MobEffect;
+import org.bukkit.potion.PotionEffect;
+import org.bukkit.potion.PotionEffectType;
+
+public class CraftPotionUtils {
+    private CraftPotionUtils() {}
+
+    public static PotionEffect toBukkit(MobEffect effect) {
+        return new PotionEffect(PotionEffectType.getById(effect.getEffectId()),
+                                effect.getDuration(),
+                                effect.getAmplifier(),
+                                effect.isAmbient(),
+                                effect.isShowParticles());
+    }
+
+    public static MobEffect toNMS(PotionEffect effect) {
+        return new MobEffect(effect.getType().getId(),
+                             effect.getDuration(),
+                             effect.getAmplifier(),
+                             effect.isAmbient(),
+                             effect.hasParticles());
+    }
+
+    public static MobEffect cloneWithDuration(MobEffect effect, int duration) {
+        return new MobEffect(effect.getEffectId(), duration, effect.getAmplifier(), effect.isAmbient(), effect.isShowParticles());
+    }
+
+    public static void extendDuration(MobEffect effect, int duration) {
+        effect.a(cloneWithDuration(effect, duration));
+    }
+}
-- 
1.9.0

